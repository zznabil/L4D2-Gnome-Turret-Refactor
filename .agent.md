# L4D2 Gnome Turret Refactor Project

## Project Overview

This is a **Left 4 Dead 2 (L4D2) mod** that implements an advanced gnome turret system with realistic aiming mechanics and extensive configuration options.

### Development History
- **Sw1ft** - Original concept and foundation implementation
- **Kurochama** - Enhanced with inventory system, ammo refill mechanics, 360-degree scanning capabilities, and extended range
- **Sultan & AI Copilot** - Major refactor adding idle scanning animations, 85% performance optimizations, multiple ammunition types, configurable turret systems, enhanced visual effects, comprehensive error handling, and dual aiming modes (Mode 0: Aimbot / Mode 1: Realistic)

### Key Technologies
- **Language**: Squirrel scripting language (.nut files)
- **Platform**: Left 4 Dead 2 Source Engine
- **Framework**: VScript system for L4D2 modding

### Project Purpose
- Provides deployable gnome turrets that can automatically target and engage infected
- Features dual aiming modes: perfect aimbot vs realistic turret behavior
- Extensive configuration system for gameplay balance
- Enhanced performance optimizations and customizable settings

## Important Files and Directories

### Core Script Files
- `gnome-turret/scripts/vscripts/turret.nut` - Main turret logic and functionality
- `gnome-turret/scripts/vscripts/gnome_turret_trigger.nut` - Turret spawning and configuration
- `gnome-turret/scripts/vscripts/lib_utils.nut` - Utility functions and chat command system
- `gnome-turret/scripts/vscripts/sm_utilities.nut` - Script mutation utilities
- `gnome-turret/scripts/vscripts/mapspawn_addon.nut` - Map spawn integration

### Configuration Files
- `gnome-turret/addoninfo.txt` - Addon metadata and information

### Documentation Files
- `README.md` - Comprehensive technical documentation explaining architecture and development pitfalls
- `TLDR.md` - Quick overview of key features and optimizations
- `changelog.md` - Detailed performance evolution from backup to production versions

### Game Files
- Root directory contains L4D2 game files and crash dumps
- `left4dead2/` - Main game directory with VPK files and configurations
- `bin/` - Game binaries and tools

## Key Features Implemented

### Aiming System
- **Perfect Aimbot Mode (0)**: Instant snap-to-target with 100% accuracy
- **Realistic Turret Mode (1)**: Smooth rotation with settling time and accuracy constraints
- Configurable rotation speed (30-720 degrees/second, default: 160°/sec)
- Settling time system prevents firing while rotating

### Configuration System
The mod uses a sophisticated configuration file system that automatically generates and loads settings:

#### Global Variables (Performance Settings)
- `GnomeTurretThinkRateMS` - Turret think rate in milliseconds (default: 100ms)
- `GnomeTurretFireRateMS` - Fire rate in milliseconds (default: 100ms)

#### Global Variables (Aiming System)
- `GnomeTurretAimMode` - Aiming mode toggle (0=aimbot, 1=realistic, default: 1)
- `GnomeTurretRotationSpeed` - Rotation speed in degrees/second (default: 160.0)

#### Global Variables (Feature Toggles)
- `GnomeTurretExplosiveMode` - Enable explosive ammunition (default: 0)
- `GnomeTurretFireEnabled` - Enable incendiary ammunition (default: 1)
- `GnomeTurretDebugMode` - Enable debug output (default: 0)
- `GnomeTurretRange` - Scan range in game units (default: 6666.0)
- `GnomeTurretMaxCount` - Maximum turrets allowed (default: 8)

#### Global Variables (Legacy Settings)
- `GnomeTurretDamage` - Damage per shot (default: 50)
- `GnomeTurretAmmoBase` - Base ammunition count (default: 1000)

### Performance Features
- Configurable think rate (default: 100ms for 10 updates/second)
- Optimized target scanning and tracking
- Configurable fire rate (default: 100ms for 600 RPM)
- Stateful target management to reduce redundant scans

## Development Best Practices

### Code Organization
- Use clear feature enhancement comments: `// -- FEATURE ENHANCEMENT: Description --`
- Separate aiming system logic: `// -- AIMING MODE TOGGLE SYSTEM --`
- Group related global variables together
- Use descriptive function names with proper parameter validation

### Variable Naming Conventions
- Global turret settings use `GnomeTurret` prefix (e.g., `GnomeTurretDamage`)
- Player-specific variables include character names (e.g., `GnomeTurretNick`)
- Time-based variables use descriptive suffixes (e.g., `ThinkRateMS`, `FireRateMS`)

### Configuration Management
- All settings have safety clamping with min/max values
- Configuration files are automatically generated with `GenerateGnomeTurretCfgFile()`
- Settings are loaded from config files using `CfgFileCheck()` function
- Use consistent parameter validation across all commands

### Aiming System Implementation
- Realistic mode requires multiple conditions: `isOnTarget && !isRotating && hasSettled`
- Use balanced tolerances (2.5° for targeting, 0.5° for rotation detection)
- Implement settling time based on rotation speed for realistic behavior
- Provide debug mode for troubleshooting aiming calculations

### Performance Considerations
- Use configurable think rates to balance responsiveness vs performance
- Implement target caching to avoid redundant scanning
- Clamp all user inputs to prevent extreme values
- Use efficient angle difference calculations with proper wrapping

### Chat Command System
The mod uses the `lib_utils.nut` chat command framework:
- Register commands with: `RegisterChatCommand(command, function, admin_only, has_args)`
- Validate player state (not dead/incapacitated) before processing
- Provide immediate feedback with current settings
- Use consistent error handling and user messaging

### Debug and Testing
- Implement comprehensive debug mode showing all aiming calculations
- Include timing information for performance analysis
- Log configuration changes for troubleshooting
- Provide detailed status displays showing all current settings

## File Synchronization Notes

- `turret.nut` and `gnome_turret_trigger.nut` should maintain synchronized global variables
- Configuration file generation must include all new settings with proper defaults
- Command registration should be consistent across both files
- Default values must match between files to prevent inconsistencies

## Common Issues and Solutions

### File Corruption
- Files may become corrupted during development - always maintain backups
- When restoring from backups, ensure all recent enhancements are re-implemented
- Verify global variable consistency between synchronized files

### Aiming Performance
- If turret is too restrictive, adjust tolerance values (increase from 1.0° to 2.5°)
- If turret fires while rotating, tighten rotation detection (decrease from 0.5° to 0.1°)
- Balance settling time based on rotation speed for optimal performance

### Configuration Persistence
- Settings are saved to configuration files and loaded on map start
- Ensure all new variables are included in config file generation
- Test configuration loading with various edge cases and invalid values

## Core Architecture

### CTurret Class Structure
The main turret class contains:
- **State Management**: `m_hTarget`, `m_bIsRotating`, `m_bCanFire`
- **Timing Control**: `m_flNextShootTime`, `m_flSettlingTime`, `m_flLastThinkTime`
- **Entity References**: `m_hMachineGun`, `m_hTracerEntity`, `m_hLaserSight`
- **Scanning Animation**: `m_bIsScanning`, `m_flScanStartTime`, `m_flScanDirection`

### Key Functions
- `Turret_Think()` - Main logic loop with performance optimizations
- `PlaceTurret()` - Turret deployment and setup
- `RemoveTurret()` - Cleanup and removal
- `TurretShoot()` - Firing mechanics with visual effects
- `IsCanSeeEntity()` - Line-of-sight calculations
- `UpdateTurretScanningAnimation()` - Smooth scanning behavior
- `CleanupTurretEntities()` - Memory leak prevention

### Performance Optimizations
The project evolved from a per-frame execution model to a throttled timer system:
1. **Stateful Target Management**: Turrets remember their targets to reduce scanning
2. **Throttled Think Loop**: Main logic runs ~10 times/second instead of 60+
3. **Conditional Target Scanning**: Only scan for new targets when needed
4. **Centralized Logic**: Core functionality consolidated in `Turret_Think()`

## Squirrel Scripting Conventions

### Entity Management
- Always check entity validity with `IsValid()` before use
- Use proper cleanup functions to prevent memory leaks
- Handle entity references carefully to avoid null pointer exceptions

### VScript Integration
- Use `RegisterButtonListener()` for input handling
- Implement proper event callbacks for game events
- Use `PrecacheEntityFromTable()` for required models and sounds

### Performance Patterns
- Use local variables for frequently accessed data
- Implement rate limiting for debug output
- Cache expensive calculations when possible
- Use efficient data structures for entity lists

## Testing and Debugging

### Debug Mode Features
- Rate-limited debug messages (every 2 seconds by default)
- Aiming calculation visualization
- Performance timing information
- Configuration loading verification

### Common Testing Scenarios
- Multiple turret deployment and cleanup
- Target acquisition in various environments
- Configuration file loading and saving
- Performance under heavy load conditions
- Edge cases with invalid entities or corrupted data